import requests
from flask import Flask, jsonify

app = Flask(__name__)

# API 인증키
API_KEY = "Cy2hhB4CjnW9YfGUIRuM8eJD2ywoJH1SBWFqYHxWi45mcv79MUbHVrYA1XK%2BeAKvgo45fGbS2%2B68GnXROF6ipw%3D%3D"

# API 엔드포인트 - 데이터 전송
@app.route("/data", methods=["GET"])
def get_data():
    # API 호출하여 데이터 가져오기
    weather_data = get_weather_data()  # 날씨 데이터 가져오기 함수 호출

    # 데이터 가공 및 필요한 형식으로 변환
    processed_data = process_weather_data(weather_data)  # 날씨 데이터 가공 함수 호출

    return jsonify(processed_data)

# 날씨 데이터 가져오기 함수
def get_weather_data():
    base_url = "http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0"
    endpoint = "/getVilageFcst"
    url = base_url + endpoint

    
    params = {
        "serviceKey": API_KEY,
        "numOfRows": 10,
        "pageNo": 1,
        "base_date": "20210628",
        "base_time": "0500",
        "nx": 55,
        "ny": 127
    }

    response = requests.get(url, params=params)
    if response.status_code == 200:
        data = response.json()
        return data

    return None

# 날씨 데이터 가공 함수
def process_weather_data(weather_data):
    # 날씨 데이터 가공 로직을 구현
    # 필요한 정보를 추출하여 필요한 형식으로 변환
    processed_data = []

    if weather_data:
        items = weather_data["response"]["body"]["items"]["item"]

        for item in items:
            date = item["baseDate"]
            weather = item["category"]
            hightemperature = item["fcstValue"]
            lowtemperature = item["fcstValue"]
            state = "Good"  # 날씨에 따라 상태를 결정하는 로직 

            processed_data.append({
                "date": date,
                "weather": weather,
                "hightemperature": hightemperature,
                "lowtemperature": lowtemperature,
                "state": state
            })

    return processed_data

if __name__ == "__main__":
    app.run()
